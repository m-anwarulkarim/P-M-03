import fs from "fs";
import path from "path";

//---------------------------------------------
// üìå filePath = users.json ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®
//---------------------------------------------
const filePath = path.join(process.cwd(), "data", "users.json");

//---------------------------------------------
// üìò readUser()
// ‚Üí ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡ßú‡ßá ‡¶è‡¶®‡ßá Object ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡ßá‡ßü
//---------------------------------------------
export const readUser = () => {
  // üîπ fs.readFileSync() ‚Üí ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá‡¶∞ ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶™‡ßú‡ßá (‡¶∏‡¶ø‡¶ô‡ßç‡¶ï‡ßç‡¶∞‡ßã‡¶®‡¶æ‡¶∏)
  // üîπ "utf-8" ‚Üí ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶™‡ßú‡¶¨‡ßá, ‡¶®‡¶æ ‡¶π‡¶≤‡ßá Buffer ‡¶™‡ßá‡¶§‡¶æ‡¶Æ
  const data = fs.readFileSync(filePath, "utf-8");

  // üîπ JSON.parse() ‚Üí ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç‡¶ï‡ßá ‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡ßá
  //    ‡¶Ø‡ßá‡¶Æ‡¶®: "{ "name": "Ayan" }" ‚Üí { name: "Ayan" }
  return JSON.parse(data);
};

//---------------------------------------------
// üìò writeUser(user)
// ‚Üí ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ/‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ‡¶ï‡ßá JSON ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡ßá‡ßü
//---------------------------------------------
export const writeUser = (user: any) => {
  /*
    üîπ JSON.stringify(user, null, 2)
       - user ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶ï‡ßá JSON ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶¨‡¶æ‡¶®‡¶æ‡¶¨‡ßá
       - null ‚Üí replacer ‡¶®‡ßá‡¶á
       - 2 ‚Üí ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá (indentation)

    ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:
    writeUser({ name: "Karim", age: 18 })

    ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶π‡¶¨‡ßá:
    {
      "name": "Karim",
      "age": 18
    }
  */

  fs.writeFileSync(filePath, JSON.stringify(user, null, 2));
};
// üíö ‡¶Ü‡¶∞‡ßá‡¶ï‡¶ü‡ßÅ ‡¶∏‡¶π‡¶ú ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂

// readUser() ‚Üí ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡¶ø‡ßü‡ßá Object ‡¶ï‡¶∞‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡ßá‡ßü

// writeUser() ‚Üí Object ‡¶ï‡ßá JSON ‡¶¨‡¶æ‡¶®‡¶ø‡ßü‡ßá ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßá
// -----------------------------------------------
//
// -----------------------------------------------
// ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ POST /api/users ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶®‡¶æ‡¶ö‡ßç‡¶õ‡¶ø

import { addRoutes } from "./router";
import { parseBody } from "./utils/parseBody";
import { readUser, writeUser } from "./utils/userFile";
import { sendJson } from "./utils/sendJson";

addRoutes("POST", "/api/users", async (req, res) => {
  const body = await parseBody(req);

  //---------------------------------------------
  // 1. ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßú‡¶æ
  //---------------------------------------------
  const users = readUser();
  // readUser() JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßú‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç Array ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡¶õ‡ßá

  //---------------------------------------------
  // 2. ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
  //---------------------------------------------
  const newUser = {
    id: Date(), // ‡¶á‡¶â‡¶®‡¶ø‡¶ï ‡¶Ü‡¶á‡¶°‡¶ø ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ/‡¶∏‡¶Æ‡ßü
    ...body, // body ‡¶≠‡ßá‡¶§‡¶∞‡ßá‡¶∞ ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡¶™‡¶ø ‡¶π‡¶¨‡ßá
  };

  /*
    ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:
    newUser = {
      id: "Fri Nov 2025 ...",
      name: "Karim",
      age: 18
    }
  */

  //---------------------------------------------
  // 3. ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ Array ‡¶§‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
  //---------------------------------------------
  users.push(newUser);

  /*
    ‡¶Ü‡¶ó‡ßá users = [ { name: "Rahim" } ]

    push ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞:
    users = [
      { name: "Rahim" },
      { id: "...", name: "Karim", age: 18 }
    ]
  */

  //---------------------------------------------
  // 4. ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° users Array ‡¶Ü‡¶¨‡¶æ‡¶∞ JSON ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
  //---------------------------------------------
  writeUser(users);

  //---------------------------------------------
  // 5. ‡¶ï‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶ï‡ßá success JSON ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
  //---------------------------------------------
  sendJson(res, 200, {
    message: "User created successfully",
    user: newUser,
  });
});
