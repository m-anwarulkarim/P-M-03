// тБбтБгтБгтБвржлрж╛ржЗрж▓ ржЕржирзЗржХ ржмржбрж╝ рж╣ржУржпрж╝рж╛ржпрж╝ рж╢рзБржзрзБ ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржмрж┐рж╖ржпрж╝ржЧрзБрж▓рзЛ ржХрзНрж▓рж╛рж╕ ржЕржирзБржпрж╛ржпрж╝рзА ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗтБб
// ts-node-dev :
// ржПржЯрж╛ ржорзВрж▓ржд Node.js + TypeScript ржПрж░ ржЬржирзНржп live-reload / auto-restart рж╕рзБржмрж┐ржзрж╛ ржжрзЗржпрж╝ред

// ---------------------------------
//  server.ts
// ---------------------------------
// server.ts
import { createServer, IncomingMessage, ServerResponse } from "http";

/*
  ржПржЗ рж╕рж╛рж░рзНржнрж╛рж░ржЯрж┐ /api/users ржП POST рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рж╛рж░ ржЬржирзНржп рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред
  ржпрж╛ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржерзЗржХрзЗ ржкрж╛ржарж╛ржирзЛ JSON ржбрзЗржЯрж╛ рж░рж┐рж╕рж┐ржн ржХрж░ржмрзЗ ржПржмржВ ржЖржмрж╛рж░ JSON ржЖржХрж╛рж░рзЗ рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛ржарж╛ржмрзЗред
*/

const server = createServer((req: IncomingMessage, res: ServerResponse) => {
  // ржЪрзЗржХ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ ржпрзЗ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ URL '/api/users' ржПржмржВ ржорзЗржержб 'POST' ржХрж┐ ржирж╛
  if (req.url === "/api/users" && req.method === "POST") {
    let body = ""; // POST ржбрзЗржЯрж╛ рж╕ржВрж░ржХрзНрж╖ржгрзЗрж░ ржЬржирзНржп ржПржХржЯрж┐ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓

    // 'data' ржЗржнрзЗржирзНржЯ рж▓рж┐рж╕рзЗржирж╛рж░:
    // ржпржЦржи ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржерзЗржХрзЗ ржбрзЗржЯрж╛ ржЖрж╕ржмрзЗ, рждржЦржи chunk ржЖржХрж╛рж░рзЗ body рждрзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣ржмрзЗ
    req.on("data", (chunk) => {
      body += chunk;
    });

    // 'end' ржЗржнрзЗржирзНржЯ рж▓рж┐рж╕рзЗржирж╛рж░:
    // ржпржЦржи рж╕ржм ржбрзЗржЯрж╛ ржЪрж▓рзЗ ржЖрж╕ржмрзЗ, рждржЦржи ржПржЯрж┐ ржЯрзНрж░рж┐ржЧрж╛рж░ рж╣ржмрзЗ
    req.on("end", () => {
      try {
        // JSON.parse ржжрж┐ржпрж╝рзЗ рж╕рзНржЯрзНрж░рж┐ржВржХрзЗ ржЬрж╛ржнрж╛рж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржЕржмржЬрзЗржХрзНржЯрзЗ рж░рзВржкрж╛ржирзНрждрж░ ржХрж░рж╛
        const parsedBody = JSON.parse(body);

        // рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржбрзЗржЯрж╛ ржХржирж╕рзЛрж▓-ржП ржжрзЗржЦрж╛ржирзЛ
        console.log(parsedBody);

        // ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯржХрзЗ JSON ржЖржХрж╛рж░рзЗ рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛ржарж╛ржирзЛ // ржЖржнрж╛ржмрзЗ рж▓рзЗржЦрж╛ржЯрж╛ ржнрж╛рж▓рзЛ
        res.setHeader("Content-Type", "application/json");
        res.end(JSON.stringify(parsedBody));
      } catch (error: any) {
        // ржпржжрж┐ JSON ржкрж╛рж░рзНрж╕рж┐ржВ ржмрж╛ ржЕржирзНржп ржХрзЛржирзЛ ржПрж░рж░ рж╣ржпрж╝, рждрж╛ ржХржирж╕рзЛрж▓-ржП ржжрзЗржЦрж╛ржирзЛ
        console.log("Error parsing JSON:", error.message);

        // ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯржХрзЗ 400 Bad Request рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛ржарж╛ржирзЛ
        res.statusCode = 400;
        res.end(JSON.stringify({ error: "Invalid JSON" }));
      }
    });
  } else {
    // ржпржжрж┐ URL ржмрж╛ ржорзЗржержб ржорж┐рж▓рзЗ ржирж╛ ржпрж╛ржпрж╝ // ржПржЯрж╛ ржкрзНрж░рзЯрзЗрж╛ржЬрзЗрж╛ржирзАрзЯ ржпржжрж┐ржУ class ржП ржжрзЗржЦрж╛ржирзЗрж╛ рж╣рзЯржирж┐
    res.statusCode = 404;
    res.end("Not Found");
  }
});

// рж╕рж╛рж░рзНржнрж╛рж░ рж▓рж┐рж╕рзЗржи ржХрж░рж╛
const PORT = 3000;
server.listen(PORT, () => {
  console.log(`Server is running on http://localhost:${PORT}`);
});

/* 
ЁЯТб рж╕ржВржХрзНрж╖рзЗржкрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛:

1я╕ПтГг req.on("data") тЖТ ржХрзНрж▓рж╛рзЯрзЗржирзНржЯ ржерзЗржХрзЗ ржЖрж╕рж╛ ржбрзЗржЯрж╛рж░ ржЕржВрж╢ ржзрж░рзЗ рж░рж╛ржЦрзЗ  
2я╕ПтГг req.on("end") тЖТ рж╕ржм ржЕржВрж╢ ржЖрж╕рж╛рж░ ржкрж░рзЗ trigger рж╣рзЯ  
3я╕ПтГг JSON.parse() тЖТ string ржбрзЗржЯрж╛ржХрзЗ JS object ржП рж░рзВржкрж╛ржирзНрждрж░ ржХрж░рзЗ  
4я╕ПтГг res.setHeader() тЖТ Response type JSON рж╣рж┐рж╕рзЗржмрзЗ рж╕рзЗржЯ ржХрж░рзЗ  
5я╕ПтГг res.end() тЖТ ржХрзНрж▓рж╛рзЯрзЗржирзНржЯржХрзЗ Response ржкрж╛ржарж╛рзЯ  
6я╕ПтГг res.statusCode = 400 тЖТ JSON invalid рж╣рж▓рзЗ Bad Request ржжрзЗржЦрж╛рзЯ  

*/
